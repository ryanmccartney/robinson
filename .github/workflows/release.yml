# .github/workflows/release.yml
name: Build and Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
  workflow_dispatch:

env:
    HUSKY: 0

jobs:
    check-frontend:
      runs-on: ubuntu-latest
      name: Check Frontend
      steps:
        - name: Checkout source code
          uses: actions/checkout@v4

        - name: Install dependencies
          run: cd ./frontend && npm ci

        - name: Check the formatting
          run: cd ./frontend && npm run format

        - name: Check the linting
          run: cd ./frontend && npm run lint

        - name: Run tests
          run: cd ./frontend && npm run test
          
    check-backend:
      runs-on: ubuntu-latest
      name: Check Backend
      steps:
        - name: Checkout source code
          uses: actions/checkout@v4

        - name: Install dependencies
          run: cd ./backend && npm ci

        - name: Check the formatting
          run: cd ./backend && npm run format

        - name: Check the linting
          run: cd ./backend && npm run lint

        - name: Run tests
          run: cd ./backend && npm run test

    release:
      runs-on: ubuntu-latest
      name: Create Release
      needs:
        - check-backend
        - check-frontend
      steps:
        - name: Checkout source code
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Initialize Git user
          run: |
            git config --global user.email "ryan@mccartney.info"
            git config --global user.name "Release Workflow"

        - name: Log git status
          run: git status

        - name: Install the frontend dependencies
          run: cd ./frontend && npm ci
      
        - name: Update frontend version number
          run: cd ./frontend && npm run release --ci

        - name: Install the backend dependencies
          run: cd ./backend && npm ci

        - name: Update the docs
          run: cd ./backend && npm run docs && git add ../docs/assets/api.yml ../docs/pages/api/index.md

        - name: Run release
          run: cd ./backend && npm run release --ci
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}