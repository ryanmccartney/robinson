# .github/workflows/release.yml
name: Release

on: workflow_dispatch

env:
    regsitry: "ghcr.io"

jobs:
    release:
      runs-on: ubuntu-latest
      name: Create Release
      steps:
        - name: Checkout source code
          uses: actions/checkout@v4
        - name: Show contents of directory
          run: ls
        - name: Initialize Git user
          run: |
            git config --global user.email "ryan@mccartney.info"
            git config --global user.name "Release Workflow"
        - name: Log git status
          run: git status
        - name: Install the dependencies
          run: cd ./backend && npm ci
        - name: Run release
          run: cd ./backend && npm run release --ci
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    deploy:
      runs-on: ubuntu-latest
      needs: release
      steps:
        #Get the repository
        - name: Checkout source code
          uses: actions/checkout@v4

        #Install dependencies
        - name: Install the backend dependencies
          run: cd ./backend && npm ci
        - name: Install the frontend dependencies
          run: cd ./frontend && npm ci

        #Get the build time
        - name: Set current date and time as an environment variable
          run: echo "timestamp=$(date +'%Y-%m-%dT%H:%M:%S')" >> $GITHUB_ENV
        - name: Print current date and time
          run: echo ${{ env.timestamp }}

        #Get the package.json version
        - uses: martinbeentjes/npm-get-version-action@master
          name: Get Version Number
          id: version
          with:
              path: ./backend
        - name: Print Current Version
          run: echo Building with version ${{ steps.version.outputs.current-version }}

        #Build and move the frontend
        - name: Build the frontend
          run: npm run build
        - name: Move build files to the backend folder
          run: mv -r ./build/* ./../backend/build/*

        #Login to GHCR
        - name: Login to GHCR Registry
          uses: docker/login-action@v2
          with:
              registry: ${{ env.regsitry }}
              username: ${{ github.actor }}
              password: ${{ secrets.GITHUB_TOKEN }}
              logout: false
        
        #Build and push the image
        - name: Build and push to registry
          uses: docker/build-push-action@v3
          with:
              context: "./backend"
              push: ${{ github.event_name != 'pull_request' }}
              tags: |
                  ${{env.regsitry}}/ryanmccartney/robinson:latest
                  ${{env.regsitry}}/ryanmccartney/robinson:${{steps.version.outputs.current-version}}
              outputs: type=registry
              labels: |
                  author=${{github.actor}}
                  version=${{steps.version.outputs.current-version}}
                  org.opencontainers.image.licenses=GPLv3
                  org.opencontainers.image.url=${{github.server_url}}/${{github.repository}}
                  org.opencontainers.image.source=${{github.server_url}}/${{github.repository}}
                  info.mccartney.ryan.build.timestamp=${{env.timestamp}}
                  info.mccartney.ryan.build.number=${{github.run_number}}
                  info.mccartney.ryan.build.id=${{github.run_id}}
                  info.mccartney.ryan.build.branch=${{github.ref_name}}
                  info.mccartney.ryan.build.commit=${{github.sha}}
                  info.mccartney.ryan.build.repository=${{github.server_url}}/${{github.repository}}
